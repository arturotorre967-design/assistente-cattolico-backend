from fastapi import FastAPI
from pydantic import BaseModel

app = FastAPI()

class AskRequest(BaseModel):
    question: str

class SpiritualAnswer(BaseModel):
    answer: str
    source: str
    explanation: str

@app.post("/api/ask", response_model=SpiritualAnswer)
async def ask_question(request: AskRequest):
    question = request.question.lower()

    vietato = ["tarocchi", "oroscopo", "magia", "reiki", "energie"]
    if any(p in question for p in vietato):
        return SpiritualAnswer(
            answer="La Chiesa cattolica insegna di evitare pratiche esoteriche o superstiziose.",
            source="Catechismo della Chiesa Cattolica, n. 2116",
            explanation="Qualsiasi forma di divinazione o magia è contraria alla fede cristiana."
        )

    database = [
        {
            "keywords": ["sofferenza", "dolore", "croce"],
            "answer": "«Se qualcuno vuole venire dietro a me, rinneghi se stesso, prenda la sua croce e mi segua.»",
            "source": "Vangelo secondo Matteo 16,24",
            "explanation": "Gesù invita a vivere la sofferenza uniti a Lui, trasformandola in amore."
        },
        {
            "keywords": ["paura", "ansia", "timore"],
            "answer": "«Non temere, perché io sono con te.»",
            "source": "Isaia 41,10",
            "explanation": "Dio rassicura il credente: la Sua presenza vince ogni paura."
        },
        {
            "keywords": ["peccato", "confessione", "perdono"],
            "answer": "«A chi rimetterete i peccati saranno rimessi.»",
            "source": "Giovanni 20,23",
            "explanation": "Cristo ha affidato alla Chiesa il potere di perdonare i peccati."
        },
        {
            "keywords": ["fede", "credere"],
            "answer": "«Accresci in noi la fede!»",
            "source": "Luca 17,5",
            "explanation": "La fede è un dono che cresce chiedendolo a Dio."
        }
    ]

    for entry in database:
        if any(k in question for k in entry["keywords"]):
            return SpiritualAnswer(
                answer=entry["answer"],
                source=entry["source"],
                explanation=entry["explanation"]
            )

    return SpiritualAnswer(
        answer="«Cercate prima il Regno di Dio e la sua giustizia.»",
        source="Matteo 6,33",
        explanation="Quando non troviamo subito una risposta, il Vangelo invita a confidare nella Provvidenza."
    )
